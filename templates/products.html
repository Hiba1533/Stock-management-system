<!-- templates/products.html -->
{% extends "base.html" %}

{% block content %}
<div class="row mt-4">
  <div class="col-md-12">
    <div class="d-flex justify-content-between align-items-center">
      <h2><i class="bi bi-box-seam"></i> Product Management</h2>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
        <i class="bi bi-plus"></i> Add Product
      </button>
    </div>
    <hr>
  </div>
</div>

<div class="row mb-3">
  <div class="col-md-6">
    <div class="input-group">
      <input type="text" class="form-control" id="productSearch" placeholder="Search products...">
      <button class="btn btn-outline-secondary" type="button">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </div>
  <div class="col-md-6 text-end">
    <div class="btn-group">
      <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
        Filter by Category
      </button>
      <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="#">All Categories</a></li>
        {% for category in categories %}
        <li><a class="dropdown-item" href="#">{{ category.name }}</a></li>
        {% endfor %}
      </ul>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-md-12">
    <div class="card shadow">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover" id="productTable">
            <thead>
              <tr>
                <th>SKU</th>
                <th>Product Name</th>
                <th>Category</th>
                <th>Brand</th>
                <th>Price</th>
                <th>Stock</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for product in products %}
              <tr>
                <td>{{ product.sku }}</td>
                <td>{{ product.name }}</td>
                <td>{{ product.category_name if product.category_name else '-' }}</td>
                <td>{{ product.brand if product.brand else '-' }}</td>
                <td>${{ "%.2f"|format(product.unit_price) }}</td>
                <td>
                  <span class="badge bg-{{ 'success' if product.quantity > product.min_stock_level else 'warning' }}">
                    {{ product.quantity }}
                  </span>
                </td>
                <td>
                  <!-- EDIT: a simple button with data-* (no data-bs-toggle/target, no href) -->
                  <button type="button"
                          class="btn btn-sm btn-outline-primary edit-btn"
                          data-id="{{ product.product_id }}"
                          data-sku="{{ product.sku }}"
                          data-name="{{ product.name }}"
                          data-description="{{ product.description or '' }}"
                          data-category-id="{{ product.category_id or '' }}"
                          data-brand="{{ product.brand or '' }}"
                          data-size="{{ product.size or '' }}"
                          data-color="{{ product.color or '' }}"
                          data-min="{{ product.min_stock_level or 0 }}"
                          data-unit-price="{{ product.unit_price or 0 }}"
                          data-cost-price="{{ product.cost_price or 0 }}">
                    <i class="bi bi-pencil"></i>
                  </button>

                  <!-- DELETE: simple button with data-* -->
                  <button type="button"
                          class="btn btn-sm btn-outline-danger delete-btn"
                          data-id="{{ product.product_id }}"
                          data-name="{{ product.name }}">
                    <i class="bi bi-trash"></i>
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Product Modal (unchanged) -->
<div class="modal fade" id="addProductModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add New Product</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" action="{{ url_for('add_product') }}">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">SKU</label>
            <input type="text" class="form-control" name="sku" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Product Name</label>
            <input type="text" class="form-control" name="name" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea class="form-control" name="description"></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Category</label>
            <select class="form-select" name="category_id">
              <option value="">Select Category</option>
              {% for category in categories %}
              <option value="{{ category.category_id }}">{{ category.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Brand</label>
              <input type="text" class="form-control" name="brand">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Size</label>
              <input type="text" class="form-control" name="size">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Color</label>
              <input type="text" class="form-control" name="color">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Min Stock Level</label>
              <input type="number" class="form-control" name="min_stock_level" value="5" min="0">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Unit Price</label>
              <input type="number" step="0.01" class="form-control" name="unit_price" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Cost Price</label>
              <input type="number" step="0.01" class="form-control" name="cost_price" required>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary">Add Product</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Shared Edit Product Modal (ONE per page) -->
<div class="modal fade" id="productEditModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="productEditForm"
          method="POST"
          data-action-template="{{ url_for('edit_product', product_id=0) }}"
          class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Product</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" id="p_id" name="product_id">

        <div class="mb-3">
          <label class="form-label">SKU</label>
          <input type="text" class="form-control" id="p_sku" name="sku" required>
        </div>

        <div class="mb-3">
          <label class="form-label">Product Name</label>
          <input type="text" class="form-control" id="p_name" name="name" required>
        </div>

        <div class="mb-3">
          <label class="form-label">Description</label>
          <textarea class="form-control" id="p_description" name="description"></textarea>
        </div>

        <div class="mb-3">
          <label class="form-label">Category</label>
          <select class="form-select" id="p_category" name="category_id">
            <option value="">Select Category</option>
            {% for category in categories %}
            <option value="{{ category.category_id }}">{{ category.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">Brand</label>
            <input type="text" class="form-control" id="p_brand" name="brand">
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Size</label>
            <input type="text" class="form-control" id="p_size" name="size">
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">Color</label>
            <input type="text" class="form-control" id="p_color" name="color">
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Min Stock Level</label>
            <input type="number" class="form-control" id="p_min" name="min_stock_level" min="0">
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">Unit Price</label>
            <input type="number" step="0.01" class="form-control" id="p_unit_price" name="unit_price" required>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Cost Price</label>
            <input type="number" step="0.01" class="form-control" id="p_cost_price" name="cost_price" required>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="submit" class="btn btn-primary">Save Changes</button>
      </div>
    </form>
  </div>
</div>

<!-- Shared Delete Product Modal (ONE per page) -->
<div class="modal fade" id="productDeleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <p>Are you sure you want to delete <strong id="del_name"></strong>?</p>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <a id="del_confirm" href="#" class="btn btn-danger">Delete</a>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  // Bootstrap modals
  const editEl = document.getElementById('productEditModal');
  const delEl  = document.getElementById('productDeleteModal');
  const editModal = editEl ? new bootstrap.Modal(editEl, { backdrop: true }) : null;
  const delModal  = delEl  ? new bootstrap.Modal(delEl,  { backdrop: true }) : null;

  // Open EDIT modal
  document.addEventListener('click', function(e){
    const btn = e.target.closest('.edit-btn');
    if (!btn) return;

    // Fill fields from data-*
    const id = btn.dataset.id || '';
    document.getElementById('p_id').value            = id;
    document.getElementById('p_sku').value           = btn.dataset.sku || '';
    document.getElementById('p_name').value          = btn.dataset.name || '';
    document.getElementById('p_description').value   = btn.dataset.description || '';
    document.getElementById('p_brand').value         = btn.dataset.brand || '';
    document.getElementById('p_size').value          = btn.dataset.size || '';
    document.getElementById('p_color').value         = btn.dataset.color || '';
    document.getElementById('p_min').value           = btn.dataset.min || 0;
    document.getElementById('p_unit_price').value    = btn.dataset.unitPrice || btn.dataset.unitprice || 0;
    document.getElementById('p_cost_price').value    = btn.dataset.costPrice || btn.dataset.costprice || 0;

    // Set category
    const sel = document.getElementById('p_category');
    if (sel) sel.value = btn.dataset.categoryId || '';

    // Set form action from template (e.g., /edit_product/0 -> /edit_product/<id>)
    const form = document.getElementById('productEditForm');
    const tmpl = form.getAttribute('data-action-template');
    if (tmpl && id) form.action = tmpl.replace(/0$/, String(id));

    editModal && editModal.show();
  }, { passive:false });

  // Open DELETE modal
  document.addEventListener('click', function(e){
    const btn = e.target.closest('.delete-btn');
    if (!btn) return;

    const id = btn.dataset.id;
    const name = btn.dataset.name || '';
    document.getElementById('del_name').textContent = name;

    const a = document.getElementById('del_confirm');
    a.href = "{{ url_for('delete_product', product_id=0) }}".replace(/0$/, String(id));

    delModal && delModal.show();
  }, { passive:false });

  // Optional: prevent double-submit
  document.getElementById('productEditForm')?.addEventListener('submit', function(){
    const s = this.querySelector('button[type="submit"]');
    if (s) { s.disabled = true; setTimeout(()=> s.disabled = false, 1500); }
  });
})();
</script>
{% endblock %}
