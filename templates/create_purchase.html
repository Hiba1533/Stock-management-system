<!-- templates/create_purchase.html -->
{% extends "base.html" %}

{% block content %}
<div class="row mt-4">
    <div class="col-md-12">
        <h2><i class="bi bi-cart-plus"></i> Create Purchase Order</h2>
        <hr>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <form id="orderForm" method="POST" action="{{ url_for('create_purchase') }}">
            <input type="hidden" id="items" name="items">
            
            <div class="card shadow mb-4">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold">Supplier Information</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Supplier</label>
                            <select class="form-select" name="supplier_id" required>
                                <option value="">Select Supplier</option>
                                {% for supplier in suppliers %}
                                <option value="{{ supplier.supplier_id }}">{{ supplier.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Expected Delivery Date</label>
                            <input type="date" class="form-control" name="expected_delivery" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" name="notes" rows="2"></textarea>
                    </div>
                </div>
            </div>

            <div class="card shadow mb-4">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold">Order Items</h6>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="input-group">
                                <select class="form-select" id="productSelect">
                                    <option value="">Select Product</option>
                                    {% for product in products %}
                                    <option value="{{ product.product_id }}" 
                                        data-name="{{ product.name }}" 
                                        data-price="{{ product.cost_price }}">
                                        {{ product.name }} ({{ product.sku }}) - Cost: ${{ "%.2f"|format(product.cost_price) }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <button class="btn btn-primary add-item-btn" type="button">
                                    <i class="bi bi-plus"></i> Add Item
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table" id="itemsTable">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Qty</th>
                                    <th>Unit Cost</th>
                                    <th>Total</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Items will be added here dynamically -->
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3" class="text-end"><strong>Total:</strong></td>
                                    <td id="totalAmount">$0.00</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <div class="text-end mb-4">
                <a href="{{ url_for('purchases') }}" class="btn btn-secondary">Cancel</a>
                <button type="submit" class="btn btn-primary">Create Purchase Order</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Add item to purchase order
    $('.add-item-btn').on('click', function() {
        const productSelect = $('#productSelect');
        const selectedOption = productSelect.find('option:selected');
        const productId = selectedOption.val();
        
        if (!productId) {
            alert('Please select a product');
            return;
        }
        
        const productName = selectedOption.data('name');
        const price = selectedOption.data('price');
        
        // Check if item already exists in the table
        if ($(`#item-${productId}`).length) {
            // Increment quantity
            const qtyInput = $(`#item-${productId} .item-qty`);
            qtyInput.val(parseInt(qtyInput.val()) + 1);
            updateItemTotal(productId);
        } else {
            // Add new row
            $('#itemsTable tbody').append(`
                <tr id="item-${productId}">
                    <td>${productName}</td>
                    <td><input type="number" class="form-control form-control-sm item-qty" value="1" min="1"></td>
                    <td class="item-price">${price.toFixed(2)}</td>
                    <td class="item-total">${price.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-sm btn-danger remove-item" data-id="${productId}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `);
            
            // Add event listeners for the new row
            $(`#item-${productId} .item-qty`).on('change', function() {
                updateItemTotal(productId);
            });
            
            $(`#item-${productId} .remove-item`).on('click', function() {
                $(this).closest('tr').remove();
                calculateTotal();
            });
        }
        
        calculateTotal();
        productSelect.val('').trigger('change');
    });

    // Calculate item total when quantity changes
    function updateItemTotal(productId) {
        const qty = parseInt($(`#item-${productId} .item-qty`).val());
        const price = parseFloat($(`#item-${productId} .item-price`).text());
        const total = qty * price;
        $(`#item-${productId} .item-total`).text(total.toFixed(2));
        calculateTotal();
    }

    // Calculate order total
    function calculateTotal() {
        let total = 0;
        $('.item-total').each(function() {
            total += parseFloat($(this).text());
        });
        $('#totalAmount').text('$' + total.toFixed(2));
    }

    // Submit form
    $('#orderForm').on('submit', function(e) {
        e.preventDefault();
        
        const items = [];
        $('tbody tr[id^="item-"]').each(function() {
            const id = $(this).attr('id').replace('item-', '');
            items.push({
                id: id,
                quantity: parseInt($(this).find('.item-qty').val()),
                price: parseFloat($(this).find('.item-price').text())
            });
        });
        
        if (items.length === 0) {
            alert('Please add at least one item');
            return;
        }
        
        $('#items').val(JSON.stringify(items));
        this.submit();
    });
});
</script>
{% endblock %}